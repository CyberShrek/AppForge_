import{S as t}from"./sweetAlert2-0948e87a.js";import{s as e,n as s,i,a as n,t as o}from"./easePick-d69004c3.js";import{f as r}from"./wretch-40d1f204.js";function a(t){const e=`./css/${t}.css`,s=document.querySelector("head");if(null===s.querySelector(`link[href="${e}"]`)){const t=document.createElement("link");t.setAttribute("rel","stylesheet"),t.setAttribute("href",e),s.appendChild(t)}}class l{set core(t){if(this.coreElement)throw new Error("The core cannot be reassigned");this.coreElement=t,this.insertCallback=this.insertCallback?this.insertCallback():null}get core(){return this.coreElement}constructor(t){this.addClass=t=>this.core.classList.add(t),this.removeClass=t=>this.core.classList.remove(t),this.toggleClass=t=>this.core.classList.toggle(t),this.insertCallback=()=>{t.position?t.target.insertAdjacentElement(t.position,this.coreElement):t.target.replaceWith(this.coreElement)}}set class(t){this.core.className=t}get class(){return this.core.className}}let c;function u(t,e){h({title:"Ошибка получения данных",icon:"error",html:t,footer:e})}function h(e){const s=function(){if(!c)return"center";const{clientX:t,clientY:e}=c,s=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,i=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight,n=`${e<=i/3?"top":e>=i/3*2?"bottom":"center"}-${t<=s/3?"left":t>=s/3*2?"right":"center"}`;return"top-center"===n?"top":"bottom-center"===n?"bottom":n}();return t.fire(Object.assign({confirmButtonColor:"var(--primary-color)",position:s,showClass:{popup:"animate__animated "+d(s)},hideClass:{popup:"animate__animated animate__zoomOut"},showCloseButton:!0,allowEnterKey:!1,showConfirmButton:!1},e))}function d(t){switch(t){case"top-left":return"animate__fadeInTopLeft";case"top":return"animate__fadeInDown";case"top-right":return"animate__fadeInTopRight";case"center-left":return"animate__fadeInLeft";case"center":return"animate__fadeIn";case"center-right":return"animate__fadeInRight";case"bottom-left":return"animate__fadeInBottomLeft";case"bottom":return"animate__fadeInUp";case"bottom-right":return"animate__fadeInBottomRight";default:return""}}a("third-party/sweetalert2"),document.addEventListener("mousemove",(t=>c=t));class p extends l{constructor(t){super(t),this.core=t.target,a("header"),this.activateResetButton(),this.activateInfoButton(),this.activateHelpButton()}activateResetButton(){this.activateButton("reset",(()=>location.reload()))}activateInfoButton(){this.activateButton("info",(t=>{var e,s,i;console.log(t),e="Информация о приложении",s=["Версия программы: "+t.getAttribute("version"),"Дата последнего обновления: "+t.getAttribute("update-date"),"Технолог: "+t.getAttribute("technologist-name")],h({title:e,html:`<ul>${s.map((t=>`<li>${t}</li>`)).join("")}</ul>`,footer:i})}))}activateHelpButton(){this.activateButton("help",(t=>{var e;e=()=>function(t){const e=document.createElement("a");e.href=t,e.target="_blank",document.body.appendChild(e),e.click(),document.body.removeChild(e)}(t.getAttribute("instruction-path")),h({text:"Руководство",confirmButtonText:"Скачать инструкцию",showConfirmButton:!0,timer:3e3,timerProgressBar:!0,backdrop:!1}).then((t=>{t.isConfirmed&&e()}))}))}activateButton(t,e){const s=this.core.querySelector("button."+t);s.addEventListener("click",(t=>e(s)))}}function b(t,e="",...s){const i=document.createElement(t);return e&&(i.textContent=e),null==s||s.forEach((t=>i.setAttribute(Object.keys(t)[0],String(Object.values(t)[0])))),i}function m(...t){return b("div","",...t)}function f(t="",...e){return b("button",t,...e)}function g(t,...e){return b("input","",{type:t},...e)}function v(t="",...e){return b("label",t,...e)}function y(t,e=!0){const s=t.textContent;for(;null!==t.firstElementChild;)t.firstElementChild.remove();e||(t.textContent=s)}function S(t="element"){let e,s=-1;do{e=t+"-"+s++}while(null!==document.getElementById(e));return e}class C extends l{get value(){return this._value}set value(t){this._value=t,this.valueEventCallbacks.forEach((e=>e(t)))}constructor(t){super(t),this.location=t,this.valueEventCallbacks=[]}subscribe(t,e=!0){this.valueEventCallbacks.push(t),e&&t(this.value)}debounce(t,e=100){let s;return()=>{clearTimeout(s),s=setTimeout(t,e)}}}class w extends C{constructor(t){super(t),this.core=f(),this.core.addEventListener("click",(()=>{this.isAvailable&&(this.value=this.value)}))}set isAvailable(t){t?this.core.classList.remove("unavailable"):this.core.classList.add("unavailable")}get isAvailable(){return!this.core.classList.contains("unavailable")}set hint(t){this.core.setAttribute("title",t)}set text(t){this.core.textContent=t}get text(){return this.core.textContent}set image(t){this.imageElement.remove(),t&&(this.imageElement=function(t="",e="not found",...s){return b("img","",{src:t},...s)}(t),this.core.appendChild(this.imageElement))}get image(){var t;return null===(t=this.imageElement)||void 0===t?void 0:t.src}}function E(t){return isNaN(Number(t))?0:Number(t)}function x(...t){const e=[];return t.forEach((t=>e.push(...t.entries()))),new Map(e)}function B(t){return null==t?"":"object"!=typeof t?String(t):t instanceof Set?Array.from(t).join(", "):t instanceof Date?k(t):t.toString()}function k(t){const e=t.getFullYear(),s=t.getMonth()+1,i=t.getDate();return`${e}-${s<10?"0":""}${s}-${i<10?"0":""}${i}`}function M(){document.documentElement.style.cursor="wait"}function F(){document.documentElement.style.cursor="default"}a("third-party/easepick");class T extends C{constructor(t,r){super(t),this.core=m({class:"datepicker"}),r.defaultRange||(r.defaultRange=[k(new Date),k(new Date)]),this.value=r.defaultRange,function(t,r,a){new e.create({element:t,format:"DD.MM.YYYY",calendars:2,grid:2,zIndex:100,plugins:[s,i,n],lang:"ru",AmpPlugin:{darkMode:!1,resetButton:!0,dropdown:{minYear:2010,maxYear:null,months:!0,years:!0}},RangePlugin:{startDate:new o(r.defaultRange[0]),endDate:new o(r.defaultRange[1]),locale:{one:"день",few:"дня",many:"дней"},delimiter:" - "},LockPlugin:{minDays:1,maxDays:r.maxDays},css:["css/third-party/easepick.css"],setup(t){t.on("select",(e=>{a([k(e.detail.start),k(e.detail.end)]),setTimeout((()=>t.hide()),10)}))}})}(this.core,r,(t=>{this.value=t}))}}class L extends l{constructor(t,e,s){super(t),this.core=t.target,this.input=new e({target:t.target,position:"beforeend"},s),this.warningLabel=v(),this.core.appendChild(this.warningLabel)}makeValid(){this.warningLabel.textContent="",this.core.classList.remove("wrong")}makeInvalid(t){this.warningLabel.textContent=t,this.core.classList.add("wrong")}}class A extends L{constructor(t,e){super(t,T,{maxDays:E(e.getAttribute("max-days"))})}}class _ extends C{constructor(t,e){super(t),this.checkBoxElement=g("checkbox",{id:S("checkbox")}),this.labelElement=v("",{for:this.checkBoxElement.id}),this.core=m({class:"checkbox"}),this.core.append(this.checkBoxElement,this.labelElement),this.label=e.label;const s=()=>this.value=this.checkBoxElement.checked;s(),this.checkBoxElement.addEventListener("change",s)}set label(t){this.labelElement.textContent=t}}class R extends L{constructor(t,e){super(t,_,{label:e.getAttribute("label")})}}a("third-party/virtual-select");class j extends C{constructor(t,e){super(t),this.optionsRetrievalCallbacks=new Set,this.core=m({class:"select"}),this.value=null,function(t,e){VirtualSelect.init({ele:t,additionalClasses:"multiselect",disabled:!0,autofocus:!1,markSearchResults:!0,optionsCount:6,multiple:e.multiple,search:e.search,hasOptionDescription:e.showCodes,disableSelectAll:e.disableSelectAll,maxValues:e.maxValues,placeholder:"Выберите",noOptionsText:"Варианты не найдены",noSearchResultsText:"Результатов не найдено",selectAllText:"Выбрать все",searchPlaceholderText:"Поиск...",optionsSelectedText:"(выбрано)",optionSelectedText:"вариант выбран",allOptionsSelectedText:"Все",clearButtonText:"Очистить",moreText:"ещё..."})}(this.core,e),this.core.addEventListener("change",(t=>{const s=!0===e.multiple?new Set("object"==typeof t.currentTarget.value?t.currentTarget.value:[t.currentTarget.value]):t.currentTarget.value;B(this.value)!==B(s)&&(this.value=s)}))}setOptions(t){var e;const s=null===this.value?new Set:this.value instanceof Set?this.value:new Set([this.value]);if(t&&t.size>0){const i=new Set(null===(e=t.get("default"))||void 0===e?void 0:e.split(","));t.delete("default"),this.core.setOptions([...t.entries()].map((t=>({label:t[1],value:t[0],alias:t[0],description:t[0]})))),this.setSelected(s.size>0?s:i),this.core.enable()}else this.core.disable(),this.core.reset(),this.core.blur()}setSelected(t=new Set){this.core.setValue(Array.from(t))}}const q=(t,e)=>(M(),r(t).headers(e?Object.fromEntries(e):{}).get().json((t=>new Map(Object.entries(t)))).catch((t=>(u(t,"Не удалось загрузить список опций"),new Map))).finally((()=>F())));class H extends L{constructor(t,e){var s,i;const n=t=>"true"===e.getAttribute(t);super(t,j,{maxValues:E(e.getAttribute("max-values")),multiple:n("multiselect"),search:n("search"),showCodes:n("show-codes"),disableSelectAll:n("disable-select-all")}),this.configElement=e,this.optionsRetrieving=!1,this.endpointConfigElement=this.configElement.querySelector("endpoint"),this.endpointPath=null===(i=null===(s=this.endpointConfigElement)||void 0===s?void 0:s.querySelector("path"))||void 0===i?void 0:i.textContent,this.endpointSubscribedFields=new Map(this.endpointConfigElement?[...this.endpointConfigElement.querySelectorAll("subscriptions field")].map((t=>[t.textContent,null])):null),this.optionsBuffer=new Map}resolveSubscribedFields(t){this.endpointSubscribedFields.forEach(((e,s)=>{this.endpointSubscribedFields.set(s,t(s))}))}listenSubscribedFields(){if(this.endpointPath)if(this.endpointSubscribedFields.size>0){const t=new Map;this.endpointSubscribedFields.forEach(((e,s)=>e.input.subscribe((e=>{t.set(s,null!=e?B(e):null),!0===this.optionsRetrieving&&this.retrieveOptionsPromise("endpoint",q(this.endpointPath,t))}))))}else this.retrieveOptionsPromise("endpoint",q(this.endpointPath))}retrieveOptionsPromise(t,e){e.then((e=>{this.optionsBuffer.set(t,e),this.input.setOptions(x(...this.optionsBuffer.values()))}))}}class I extends H{constructor(t,e){var s;super(t,e),this.bankConfigElement=this.configElement.querySelector("bank"),this.dateFieldKey=null===(s=this.bankConfigElement.querySelector("subscriptions date"))||void 0===s?void 0:s.textContent,this.dateFieldSubscription=null}resolveSubscribedFields(t){super.resolveSubscribedFields(t),this.dateFieldSubscription=t(this.dateFieldKey)}resolveBankSubscribing(t,...e){e.forEach((s=>s.input.subscribe((s=>{for(const t of e)if(null===t.input.value||B(t.input.value).length<=0)return void this.input.setOptions(null);this.retrieveOptionsPromise("bank",t(...e.map((t=>t.input.value))))}))))}}const P=`${document.location.origin}/servicebank/getdata`,O=t=>V("perList",t,(t=>[`${t.gos}.${t.skp}`,t.nazvp]),null,null,"Не удалось загрузить список перевозчиков"),$=(t,e)=>V("gosList",t,(t=>[t.g_kod,t.g_name]),{g_prsng:"1"},(t=>!e||"1"==t.g_prsng),"Не удалось загрузить список государств"),D=async(t,e)=>{const s=e=>V("dorList",t,(t=>[`${e}.${t.d_kod}`,t.d_name]),{gos:e},null,"Не удалось загрузить список дорог");return e instanceof Set?N([...e].map((t=>s(t)))):s(e)},K=async(t,e,s)=>N([...Y(e)].map((([e,s])=>V("stanList",t,(t=>[t.stan,t.pnazv]),{gos:e,dor:s.join(","),pr_bo:"1"},null,"Не удалось загрузить список станций")))),V=(t,e,s,i={},n,o)=>(M(),r(P).post({[t]:[Object.assign({data:e[0]},i)]}).json((t=>{const e=Object.keys(t)[0];return new Map(t[e].filter((t=>!n||n(t))).map((t=>s(t))))})).catch((t=>(u(t,o),new Map))).finally((()=>F())));function N(t){return Promise.all(t).then((t=>{const e=new Map;return t.forEach((t=>{t.forEach(((t,s)=>{e.set(s,t)}))})),e})).catch((t=>{}))}function Y(t){const e=new Map,s=t=>{var s;const i=t.split("."),n=i[0],o=i[1];e.has(n)||e.set(n,[]),null===(s=e.get(n))||void 0===s||s.push(o)};return t instanceof Set?t.forEach((t=>s(t))):s(t),e}class z extends I{constructor(t,e){super(t,e)}listenSubscribedFields(){super.listenSubscribedFields(),this.resolveBankSubscribing(O,this.dateFieldSubscription)}}class W extends I{constructor(t,e){var s;super(t,e),this.postSovietKey=null===(s=this.bankConfigElement.querySelector("subscriptions postsoviet"))||void 0===s?void 0:s.textContent}resolveSubscribedFields(t){super.resolveSubscribedFields(t),this.postSovietSubscription=t(this.postSovietKey)}listenSubscribedFields(){super.listenSubscribedFields(),this.resolveBankSubscribing($,this.dateFieldSubscription,this.postSovietSubscription)}}class G extends I{constructor(t,e){var s;super(t,e),this.countriesKey=null===(s=this.bankConfigElement.querySelector("subscriptions countries"))||void 0===s?void 0:s.textContent}resolveSubscribedFields(t){super.resolveSubscribedFields(t),this.countriesSubscription=t(this.countriesKey)}listenSubscribedFields(){super.listenSubscribedFields(),this.resolveBankSubscribing(D,this.dateFieldSubscription,this.countriesSubscription)}}class U extends I{constructor(t,e){var s;super(t,e),this.roadsKey=null===(s=this.bankConfigElement.querySelector("subscriptions roads"))||void 0===s?void 0:s.textContent}resolveSubscribedFields(t){super.resolveSubscribedFields(t),this.roadsSubscription=t(this.roadsKey)}listenSubscribedFields(){super.listenSubscribedFields(),this.resolveBankSubscribing(K,this.dateFieldSubscription,this.roadsSubscription)}}a("main-form");class X extends C{constructor(t){super(t),this.fields=new Map,this.core=t.target,this.value=new Map,this.confirmButton=new w({target:this.core,position:"afterend"}),this.confirmButton.addClass("confirm"),this.confirmButton.text=this.core.getAttribute("confirm-button-text"),this.resolveFields(),this.resolveFieldsSubscriptions(),this.validationPath=this.core.getAttribute("validation-path")}resolveFields(){this.core.querySelectorAll(".section").forEach((t=>{const e=t.getAttribute("key");t.querySelectorAll(".field").forEach((t=>{const s=t.getAttribute("key");this.fields.set(`${e}.${s}`,function(t){const e=e=>t.classList.contains(e),s={target:t},i=t.querySelector("config");return e("date")?new A(s,i):e("checkbox")?new R(s,i):function(t,e){var s;switch(null===(s=e.querySelector("bank"))||void 0===s?void 0:s.getAttribute("type")){case"carriers":return new z(t,e);case"countries":return new W(t,e);case"roads":return new G(t,e);case"stations":return new U(t,e)}return new H(t,e)}(s,i)}(t))}))}))}resolveFieldsSubscriptions(){this.fields.forEach(((t,e)=>{t instanceof H&&(t.resolveSubscribedFields((t=>this.fields.get(t))),t.listenSubscribedFields(),t.optionsRetrieving=!0),t.input.subscribe((t=>{this.value.set(e,t),this.validateFields()}))}))}validateFields(){var t,e;this.confirmButton.isAvailable=!1,this.validationPath&&(t=this.validationPath,e=this.value,M(),r(t).json(Object.fromEntries(e)).post().forbidden((t=>new Map(Object.entries(t.json)))).text((()=>!0)).catch((t=>(u(t,"Ошибка валидации"),!1))).finally((()=>F()))).then((t=>{this.fields.forEach((t=>t.makeValid())),t instanceof Map?t.forEach(((t,e)=>this.fields.get(e).makeInvalid(t))):!0===t&&(this.confirmButton.isAvailable=!0)}))}}class J extends l{constructor(t){super({target:t}),this.core=t}}class Q extends J{constructor(t){super(t),this.titleElement=t.querySelector("p"),this.originTitleText=this.titleElement.textContent,this.buttonsElement=t.querySelector("div.buttons")}set title(t){this.titleElement.textContent=t}applyGraphButton(){return this.applyButton("img/graph.svg","Графическое представление")}applyExportButton(){return this.applyButton("img/download.svg","Экспортировать")}applyCollapseButton(){return this.applyButton("img/collapse.svg","Свернуть")}applyFullscreenButton(){return this.applyButton("img/expand.svg","Развернуть на весь экран")}applyToTopButton(){return this.applyButton("img/to_top.svg","Наверх")}applyButton(t,e){const s=new w({target:this.buttonsElement,position:"beforeend"});return s.image=t,s.hint=e,s}reset(){this.title=this.originTitleText,y(this.buttonsElement)}}class Z extends C{constructor(t){super(t),this.textInputElement=g("text"),this.resetButtonElement=f("❌",{class:"reset"}),this.core=m({class:"text"}),this.core.append(this.textInputElement,this.resetButtonElement),this.textInputElement.addEventListener("input",this.debounce((()=>this.value=this.textInputElement.value))),this.resetButtonElement.addEventListener("click",(()=>this.value=this.textInputElement.value=""))}}class tt extends l{constructor(t,e){super(t),this.thead=b("thead"),this.tbody=b("tbody"),this.tfoot=b("tfoot"),this.bodyContent=new Map,this.filtersMap=new Map,this.core=b("table"),this.core.append(this.thead,this.tfoot,this.tbody),e&&(this.head=e.head,this.body=e.body,e.total&&(this.total=e.total.length>0?e.total:this.calculateTotal()))}set head(t){y(this.thead),t.forEach((t=>{let e=0;this.thead.appendChild(this.createHTMLRow(t.map((t=>{const s=this.createHTMLHeadCell(t.content,t.rowSpan,t.colSpan);return!0===t.hasFilter&&this.setFilter(s,e),e+=s.colSpan,s}))))}))}set body(t){y(this.tbody),this.bodyContent=new Map,this.addBody(t)}addBody(t){var e;this.bodyContent=x(this.bodyContent,t),(e=this.filterBodyContent(this.bodyContent),new Map([...e.entries()].sort(((t,e)=>t[0]>e[0]?1:t[0]<e[0]?-1:0)))).forEach(((t,e)=>this.tbody.append(this.createHTMLRow(e.map((t=>this.createHTMLCell(t,"primary"))).concat(t.map((t=>this.createHTMLCell(String(t))))))))),this.groupPrimaryCells()}set total(t){var e;null===(e=this.tfoot.querySelector(".total"))||void 0===e||e.remove(),this.tfoot.appendChild(this.createHTMLTotalRow(t.map((t=>this.createHTMLCell(t)))))}calculateTotal(){const t=[];return this.bodyContent.forEach((e=>e.forEach(((e,s)=>{t[s]=t[s]?E(t[s])+E(e):e})))),t}createHTMLTotalRow(t){const e=this.createHTMLCell("Всего");return e.colSpan=this.tbody.querySelector("tr").querySelectorAll(".primary").length,this.createHTMLRow([e,...t],"total")}createHTMLRow(t,e){const s=b("tr","",{class:e});return s.append(...t),s}createHTMLHeadCell(t,e=1,s=1){return b("th",t,{rowspan:e},{colspan:s})}createHTMLCell(t,e){return b("td",String(t),{class:e})}setFilter(t,e){new Z({target:t}).subscribe((t=>{this.filtersMap.set(e,t),this.body=this.bodyContent}))}filterBodyContent(t){return e=t,s=(t,e)=>{const s=e.concat(t.map((t=>String(t))));for(let t=0;t<s.length;t++){const e=this.filtersMap.get(t);if(!s[t].toLowerCase().includes(e?e.toLowerCase():""))return!1}return!0},new Map(Array.from(e).filter((([t,e])=>s(e,t))));var e,s}groupPrimaryCells(t=this.tbody.firstElementChild,e=this.tbody.lastElementChild,s=0){var i;if(t===e)return;const n=t.cells[s];if(!(null===(i=null==n?void 0:n.classList)||void 0===i?void 0:i.contains("primary")))return;let o=t;do{o=o.nextElementSibling;const i=o.cells[0];if(n.textContent!==i.textContent)return this.groupPrimaryCells(t,o,s+1),void this.groupPrimaryCells(o,e);n.rowSpan++,i.hidden=!0}while(o!==e)}}class et extends l{constructor(t,e){super(t)}}class st extends J{constructor(t){super(t),this._collapsed=!1,this.toggleCollapse=()=>this.collapsed=!this.collapsed}showLoading(){this.core.appendChild(m({class:"loading"}))}applyTable(t){return this.tableModelCache=t,new tt({target:this.core,position:"beforeend"},t)}applyCharts(t){this.chartsModelCache=t;const e=m({class:"charts"});return this.core.appendChild(e),t.map((t=>new et({target:e,position:"afterbegin"},t)))}get collapsed(){return this._collapsed}set collapsed(t){this._collapsed=t,this.collapsed?y(this.core):(this.tableModelCache&&this.applyTable(this.tableModelCache),this.chartsModelCache&&this.applyCharts(this.chartsModelCache))}reset(){this.tableModelCache=void 0,this.chartsModelCache=void 0,y(this.core)}}class it extends l{constructor(t){super(t),this.location=t,this.core=t.target,this.path=this.core.getAttribute("path"),this.head=new Q(this.core.querySelector(".head")),this.body=new st(this.core.querySelector(".body"))}applyNewReportByValues(t){var e,s;this.reset(),this.body.showLoading(),(e=this.path,s=t,M(),r(e).post(s).json((t=>t)).catch((t=>u(t,"Не удалось загрузить отчёт"))).finally(F)).then((t=>this.report=t))}set report(t){this.reset(),t.title&&(this.head.title=t.title),t.table&&this.body.applyTable(t.table),t.charts&&this.body.applyCharts(t.charts),this.applyButtons(!!t.table,!!t.charts)}applyButtons(t,e){this.head.applyCollapseButton().subscribe((()=>this.body.toggleCollapse())),this.head.applyFullscreenButton(),this.head.applyToTopButton()}reset(){this.head.reset(),this.body.reset()}}a("global"),a("inputs"),a("states"),a("third-party/animate"),new class extends l{constructor(t){super(t),this.createHeader=()=>new p({target:document.getElementById("header")}),this.createReportSlots=()=>new Map([...this.core.querySelectorAll("div.report")].map((t=>[t.getAttribute("key"),new it({target:t})]))),this.core=t.target,this.header=this.createHeader(),this.mainForm=this.createMainForm(),this.reportSlots=this.createReportSlots()}createMainForm(){const t=new X({target:document.getElementById("main-form")});return t.confirmButton.subscribe((()=>{this.reportSlots.get("main").applyNewReportByValues(t.value)}),!1),t}}({target:document.body});
//# sourceMappingURL=index.js.map
