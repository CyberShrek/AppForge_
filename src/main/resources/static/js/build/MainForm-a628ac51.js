import{r as t}from"./index.js";import{s as e,i as s,a as i,n as o,t as r}from"./easePick-abdaa5ad.js";import{f as n}from"./wretch-40d1f204.js";import{p as c}from"./modal-5d0fd93c.js";import"./sweetAlert2-f9822954.js";function a(t){return isNaN(Number(t))?0:Number(t)}function l(t){const e=t.getFullYear(),s=t.getMonth()+1,i=t.getDate();return`${e}-${s<10?"0":""}${s}-${i<10?"0":""}${i}`}function u(t){return function(...t){return new Map(t.map((t=>[t.first,t.second])))}(...t.slice(1,-1).split(", ").map((t=>{const e=t.split("=");return s=e[0],i=e[1],{first:s,second:i};var s,i})))}const h=new Event("update");class d{constructor(t,e){this.core=t,this.section=e,this.dispatchUpdate=()=>this.core.dispatchEvent(h)}subscribeToFields(t,e){t.forEach((t=>this.subscribeToField(t.first,t.second,e)))}subscribeToField(t,e,s){const i=this.findFieldOrThrowError(t,e);i.core.addEventListener(h.type,(()=>s(i.value)))}findFieldOrThrowError(t,e){const s=this.section.form.sections.get(t);if(!s)throw Error(`Не удалось найти секцию с ключом "${t}"`);const i=s.fields.get(e);if(!i)throw Error(`Не удалось найти поле с ключом "${t}.${e}"`);return i}}t("third-party/easepick");class p extends d{constructor(t,n){super(t,n),this.core=t,this.section=n,function(t,n){new e.create({element:t,format:"DD.MM.YYYY",calendars:2,grid:2,zIndex:100,plugins:[s,i,o],lang:"ru",AmpPlugin:{darkMode:!1,resetButton:!0,dropdown:{minYear:2010,maxYear:null,months:!0,years:!0}},RangePlugin:{startDate:new r,endDate:new r,locale:{one:"день",few:"дня",many:"дней"},delimiter:" - "},LockPlugin:{minDays:1,maxDays:a(t.getAttribute("max-days"))},css:["css/third-party/easepick.css"],setup(t){t.on("select",(e=>{n(e.detail.start,e.detail.end),setTimeout((()=>t.hide()),10)}))}})}(t,((t,e)=>{this.value={start:l(t),end:l(e)},this.dispatchUpdate()}))}}const b=`${document.location.origin}/servicebank/getdata`,f=(t,e,s,i={},o)=>n(b).post({[t]:[Object.assign({data:e},i)]}).json((t=>t[Object.keys(t)[0]].map((t=>{const e=s(t);return e.description=e.value,e.alias=e.value,e})))).catch((t=>{throw c(t,o),t})),m=t=>{var e;const s=new Map;for(const i of t){const t=i.split("."),o=t[0],r=t[1];s.has(o)||s.set(o,[]),null===(e=s.get(o))||void 0===e||e.push(r)}return s};t("third-party/virtual-select.min");class y extends d{constructor(t,e){super(t,e),this.core=t,this.section=e,this.initStaticMap(),e.form.onMount((()=>{this.subscribeToAllNecessaryFields(),function(t){const e=t.querySelector("config");VirtualSelect.init({ele:t,multiple:!0,additionalClasses:"multiselect",search:!0,disabled:!0,autofocus:!1,markSearchResults:!0,optionsCount:6,showSelectedOptionsFirst:!0,hasOptionDescription:e.getAttribute("show-codes"),placeholder:"Выберите",noOptionsText:"Варианты не найдены",noSearchResultsText:"Результатов не найдено",selectAllText:"Выбрать все",searchPlaceholderText:"Поиск...",optionsSelectedText:"(выбрано)",optionSelectedText:"вариант выбран",allOptionsSelectedText:"Все",clearButtonText:"Очистить",moreText:"ещё..."})}(t),this.interceptChangeEvents(),this.staticMap&&this.setMap(this.staticMap)}))}setMap(t){this.setOptions(function(t,e=!1){return[...t.entries()].map((t=>({label:t[1],value:t[0],alias:t[0],description:!0===e?t[0]:null})))}(t))}setOptions(t){const e=this.value;t&&t.length>0?(this.core.setOptions(t),this.selectOptions(e),this.core.enable()):(this.core.disable(),this.core.reset(),this.core.blur())}selectOptions(t){this.core.setValue(t)}initStaticMap(){const t=this.core.querySelector("static");null!==t&&(this.staticMap=u(t.textContent))}interceptChangeEvents(){const t=t=>{this.value=t,this.dispatchUpdate()};this.core.addEventListener("change",(function(){t(this.value)}))}subscribeToAllNecessaryFields(){this.tryToSetCarriers(),this.tryToSetCountries(),this.tryToSetRoads(),this.tryToSetStations()}tryToSetCarriers(){const t=this.core.querySelector("config > carriers");if(null!==t){const e=t.querySelector("subscribes date").textContent.split(".");this.subscribeToField(e[0],e[1],(t=>this.updateCarriers(t.start)))}}tryToSetCountries(){const t=this.core.querySelector("config > countries");if(null!==t){const e=t.querySelector("subscribes date").textContent.split(".");this.subscribeToField(e[0],e[1],(t=>this.updateCountries(t.start)))}}tryToSetRoads(){const t=this.core.querySelector("config > roads");if(null!==t){let e,s;const i=t.querySelector("subscribes date").textContent.split(".");this.subscribeToField(i[0],i[1],(t=>{e=t.start}));const o=t.querySelector("subscribes countries").textContent.split(".");this.subscribeToField(o[0],o[1],(t=>{s=t,void 0!==e&&this.updateRoads(s,e)}))}}tryToSetStations(){const t=this.core.querySelector("config > stations");if(null!==t){let e,s;const i=t.querySelector("subscribes date").textContent.split(".");this.subscribeToField(i[0],i[1],(t=>{e=t.start}));const o=t.querySelector("subscribes roads").textContent.split(".");this.subscribeToField(o[0],o[1],(t=>{s=t,void 0!==e&&this.updateStations(s,e)}))}}updateCarriers(t){(t=>f("perList",t,(t=>({label:t.nazvp,value:`${t.gos}.${t.skp}`})),null,"Не удалось загрузить список перевозчиков"))(t).then((t=>this.setOptions(t)))}updateCountries(t){((t,e)=>f("gosList",t,(t=>({label:t.g_name,value:t.g_kod})),null,"Не удалось загрузить список стран"))(t).then((t=>this.setOptions(t)))}updateRoads(t,e){(async(t,e)=>(await Promise.all(t.map((t=>f("dorList",e,(e=>({label:e.d_name,value:`${t}.${e.d_kod}`})),{gos:t},"Не удалось загрузить список дорог"))))).flat())(t,e).then((t=>this.setOptions(t)))}updateStations(t,e){(async(t,e,s)=>(await Promise.all(Array.from(m(t)).map((([t,s])=>f("stanList",e,(t=>({label:t.pnazv,value:t.stan})),{gos:t,dor:s.join(","),pr_bo:"1"},"Не удалось загрузить список станций"))))).flat())(t,e).then((t=>this.setOptions(t)))}}class g extends d{constructor(t,e){super(t,e),this.core=t,this.section=e}}class S{constructor(t,e){this.core=t,this.form=e,this.fields=new Map}}class x extends S{constructor(t,e){super(t,e),this.core=t,this.form=e,t.querySelectorAll(".field").forEach((t=>this.fields.set(t.getAttribute("key"),this.defineField(t))))}defineField(t){return t.classList.contains("datepicker")?new p(t,this):t.classList.contains("select")?new y(t,this):t.classList.contains("checkbox")?new g(t,this):void 0}}class T{constructor(t){this.core=t,this.sections=new Map,this.onMountExecutesList=[],this.mount=()=>{this.onMountExecutesList.forEach((t=>t())),this.onMountExecutesList=null}}onMount(t){this.onMountExecutesList.push(t)}}t("main-form");class v extends T{constructor(t){super(t),this.core=t,t.querySelectorAll(".section").forEach((t=>this.sections.set(t.getAttribute("key"),new x(t,this)))),this.mount()}}export{v as default};
//# sourceMappingURL=MainForm-a628ac51.js.map
